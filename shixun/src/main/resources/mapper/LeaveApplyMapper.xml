<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.LeaveApplyMapper">
    <resultMap id="LeaveMap" type="entity.LeaveApply">
        <id column="apply_id" property="applyId"/>
        <result column="emp_id" property="empId"/>
        <result column="dept_id" property="deptId"/>
        <result column="manager_id" property="managerId"/>
        <result column="leave_type" property="leaveType"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="days" property="days"/>
        <result column="reason" property="reason"/>
        <result column="status" property="status"/>
        <result column="approve_time" property="approveTime"/>
        <result column="emp_name" property="empName"/>
        <result column="dept_name" property="deptName"/>
        <result column="manager_name" property="managerName"/>
    </resultMap>

    <select id="selectByEmpId" resultMap="LeaveMap">
        SELECT l.*, e.emp_name, d.dept_name, m.emp_name as manager_name
        FROM t_leave_apply l
                 LEFT JOIN t_employee e ON l.emp_id = e.emp_id
                 LEFT JOIN t_department d ON l.dept_id = d.dept_id
                 LEFT JOIN t_employee m ON l.manager_id = m.emp_id
        WHERE l.emp_id = #{empId}
        ORDER BY l.apply_id DESC
    </select>

    <select id="selectByManagerId" resultMap="LeaveMap">
        SELECT l.*, e.emp_name, d.dept_name, m.emp_name as manager_name
        FROM t_leave_apply l
                 LEFT JOIN t_employee e ON l.emp_id = e.emp_id
                 LEFT JOIN t_department d ON l.dept_id = d.dept_id
                 LEFT JOIN t_employee m ON l.manager_id = m.emp_id
        WHERE l.manager_id = #{managerId}
          AND l.status = '0'
        ORDER BY l.apply_id DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="applyId">
        INSERT INTO t_leave_apply
        (emp_id, dept_id, manager_id, leave_type, start_time, end_time, days, reason, status)
        VALUES
            (#{empId}, #{deptId}, #{managerId}, #{leaveType}, #{startTime}, #{endTime},
             #{days}, #{reason}, #{status})
    </insert>

    <update id="updateStatus">
        UPDATE t_leave_apply
        SET status = #{status},
            manager_id = #{managerId},
            approve_time = #{approveTime}
        WHERE apply_id = #{applyId}
    </update>
</mapper>